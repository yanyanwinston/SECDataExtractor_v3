# User Guide & Quickstart

This guide walks through day-to-day usage: installing prerequisites, downloading
filings, rendering Excel workbooks, and debugging common issues.

## Prerequisites
- Python 3.10+ (3.11 recommended)
- macOS or Linux with 2 GB+ RAM for large filings
- Internet access for EDGAR downloads

## Setup
1. Clone the repository and install dependencies:
   ```bash
   git clone <repo-url>
   cd SECDataExtractor_v3
   ./setup.sh
   ```
2. Activate the virtual environment for interactive sessions:
   ```bash
   source venv/bin/activate
   ```
3. Sanity check the CLIs:
   ```bash
   python download_filings.py --help
   python render_viewer_to_xlsx.py --help
   python download_and_render.py --help
   ```

## Core workflow
### 1. Download a filing
```bash
python download_filings.py --ticker TSLA --form 10-K --count 1
```
Outputs land under `downloads/<ticker>/<form>_<date>/` with the primary iXBRL HTML
and exhibits (if requested).

### 2. Render to Excel
```bash
python render_viewer_to_xlsx.py \
  --filing downloads/TSLA/10-K_*/tsla-*.htm \
  --out output/tsla-10k.xlsx \
  --verbose
```
The script creates temporary directories for Arelle, extracts the viewer JSON,
matches facts to presentation tables, and writes the workbook.

### 3. Combined workflow
For quick sweeps, run the orchestrator:
```bash
python download_and_render.py --ticker AAPL --ticker MSFT --k-count 1 --q-count 2
```
Excel files will appear in `output/<ticker>/<filing>.xlsx`. Use `--overwrite` to
regenerate existing workbooks.

## Useful switches
- `--label-style {terse,standard}`: choose concept labels (terse is default).
- `--dimension-breakdown` / `--collapse-dimensions`: control whether axis/member
  combinations expand into separate rows.
- `--include-disclosures`: include MetaLinks roles that are not primary statements.
- `--one-period` or `--periods "2024,2023"`: focus on recent reporting periods.
- `--save-viewer-json …`: persist the extracted viewer payload for inspection.
- `--dump-role-map …`: write MetaLinks role metadata to CSV for triage.
- `--no-scale-hint` / `--scale-none`: disable decimals-based scaling or millions
  output when raw values are needed.

## Common workflows
- **Quarterly monitoring**
  ```bash
  python download_filings.py --ticker NVDA --form 10-Q --count 1
  python render_viewer_to_xlsx.py --filing downloads/NVDA/10-Q_*/nvda-*.htm --out output/nvda-q.xlsx
  ```
- **Historical sweep**
  ```bash
  python download_filings.py --ticker AMZN --form 10-K --start-date 2019-01-01 --end-date 2023-12-31
  for filing in downloads/AMZN/10-K_*/amzn-*.htm; do
      year=$(basename "${filing%/*}" | cut -d'_' -f2 | cut -d'-' -f1)
      python render_viewer_to_xlsx.py --filing "$filing" --out output/amzn-${year}.xlsx --one-period
  done
  ```
- **Portfolio batch via file**
  ```bash
  python download_filings.py --input-file watchlist.txt --form 10-K,10-Q --max-parallel 5
  find downloads -name "*.htm" -maxdepth 3 | while read filing; do
      ticker=$(echo "$filing" | cut -d'/' -f2)
      python render_viewer_to_xlsx.py --filing "$filing" --out output/${ticker}.xlsx --collapse-dimensions
  done
  ```

## Troubleshooting
- **"No filings found"** – verify the ticker/CIK, widen the date range, or enable
  `--include-amendments`.
- **Download timeouts** – lower `--max-parallel` and raise `--timeout`.
- **Processing failed** – re-run with `--verbose`, `--keep-temp`, and
  `--save-viewer-json` to inspect the viewer payload. Arelle logs live in the temp
  directory.
- **Missing statements** – pass `--include-disclosures` to surface schedules or
  check that MetaLinks group metadata exists. Ensure the filing is iXBRL-enabled.
- **Unexpected scaling** – combine `--no-scale-hint` with `--scale-none` to view raw
  values; watch for fact-level scale hints in the viewer JSON.

## File layout refresher
```
SECDataExtractor_v3/
├── downloads/          # Raw filings pulled from EDGAR
├── output/             # Excel workbooks generated by renderers
├── temp/               # Temporary Arelle artefacts (if --keep-temp)
├── src/                # Python source
└── tests/              # Automated regression suite
```

## When things go wrong
- Check `MetaLinks.json` exists next to the viewer HTML; pass explicit paths
  (directory from the downloader) via `--save-viewer-json` for auditing.
- Run `PYTHONPATH=. pytest -k presentation` before and after modifications to ensure
  presentation traversal still behaves as expected.
- Compare the workbook against the SEC's Interactive Data viewer when verifying fixes
  (TSLA is the primary regression reference).
