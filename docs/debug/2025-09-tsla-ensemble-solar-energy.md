# TSLA multi-year: Solar energy systems missing for 2021-2020

## Summary
- Multi-year workbook generated by `ensemble_to_xlsx.py` omits 2021 and 2020 balances for `Solar energy systems, net`.
- Values appear in a duplicate row instead of the anchor row, due to label drift between filings.

## Reproduction Steps
- Run `python ensemble_to_xlsx.py --ticker TSLA --form 10-K --count 5 --out output/tsla-multi-year.xlsx`.
- Inspect the Balance Sheet tab of `output/tsla-multi-year.xlsx`.

## Observations
- Anchor row `Solar energy systems, net` only carries 2024-2022 values.
- Additional row `Solar Energy Systems` holds the 2021 and 2020 balances.
- Balance sheet source filings processed individually:
  - 2024 10-K: concept `ns0:LeasedAssetsNet`, label `Solar energy systems, net`.
  - 2021/2020 10-Ks: concept `tsla:LeasedAssetsNet`, label `Solar Energy Systems`.

## Analysis
- Ensemble alignment relies on `_rows_match` (`src/processor/ensemble.py:159`), which demands both the normalized concept and label token to match.
- The concept local name matches across filings, and parent hierarchy/depth are identical, but the lower-cased label tokens differ (`solar energy systems, net` vs `solar energy systems`).
- Label mismatch means `_rows_match` treats the row as unique, pushing historical values into the "extra rows" bucket (`_populate_additional_rows`).

## Impact
- Historical periods populate a separate row, leaving blanks for 2021/2020 in the anchor row used for reporting.
- Downstream consumers see missing data and duplicated line items.

## Next Steps
1. Relax `_rows_match` to treat rows with matching normalized concept (plus consistent parent path/signature) as equivalent even when labels drift slightly.
2. After adjusting, rerun the TSLA multi-year command to verify all periods populate the anchor row and no duplicate line persists.
